<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Timer with Qualtrics Intercept</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        #survey-iframe { 
            width: 100%; 
            height: 500px; 
            border: 1px solid #ccc; 
        }
        #timer-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #f0f0f0;
            padding: 20px;
            border: 2px solid #333;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            z-index: 9999999999999999999;
            display: none;
            width: 300px;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000000002;
            display: none;
        }
    </style>
</head>

<body>
    <h1>Main Website</h1>
    <p>This page contains a survey in an iframe and a timer popup that may interrupt.</p>
    
    <iframe id="survey-iframe" src="https://zn9bwreamgwdwatnf-wellsfargocxsandbox.siteintercept.qualtrics.com/SIE/?Q_ZID=ZN_9BwReAmgWdWatNf" title="Survey Form"></iframe>
    
    <div class="overlay" id="overlay"></div>
    <div id="timer-popup">
        <h2>Important Notice!</h2>
        <p>Your session is about to expire. Would you like to extend your session?</p>
        <button id="continue-survey">Continue Survey</button>
    </div>
    
    <button id="trigger-popup">Simulate Timed Popup</button>

    <script>
        const overlay = document.getElementById('overlay');
        const popup = document.getElementById('timer-popup');
        const continueBtn = document.getElementById('continue-survey');
        
        let timer;
        const SESSION_TIME = 15000; // 1 minute
        let popupOpen = false;

        function startSessionTimer() {
            timer = setTimeout(showPopup, SESSION_TIME);
        }

        function showPopup() {
            if (!popupOpen) {
                popupOpen = true;
                overlay.style.display = 'block';
                popup.style.display = 'block';
                
                // Focus on the Continue Survey button
                continueBtn.focus();
            }
        }

        function resetTimer() {
            clearTimeout(timer);
            startSessionTimer(); // Restart the session timer
        }

        function closePopup() {
            overlay.style.display = 'none';
            popup.style.display = 'none';
            popupOpen = false;
        }

        function extendSession() {
            // Unload the Qualtrics intercept
            if (typeof QSI !== 'undefined' && QSI.API) {
                QSI.API.unload(); // Unload current intercept
                QSI.API.load(); // Reload the intercept
            }
            closePopup();
            resetTimer(); // Reset the timer when extending session
        }

        // Event listeners for buttons
        continueBtn.addEventListener('click', extendSession);
        document.getElementById('trigger-popup').addEventListener('click', showPopup);

        // Start the session timer when the page loads
        window.onload = function() {
            startSessionTimer();
        };
    </script>

    <!-- Qualtrics Website Feedback Snippet -->
    <script type='text/javascript'>
        (function(){
            var g=function(g){
                this.go=function(){
                    var a=document.createElement("script");
                    a.type="text/javascript";
                    a.src=g; 
                    document.body&&document.body.appendChild(a)
                };
                this.start=function(){
                    var t=this;
                    "complete"!==document.readyState?
                    window.addEventListener?window.addEventListener("load",function(){t.go()},!1):
                    window.attachEvent&&window.attachEvent("onload",function(){t.go()}):t.go()
                };
            };
            try{
                // Qualtrics intercept script with your Q_ZID placeholder
                (new g("https://zn9bwreamgwdwatnf-wellsfargocxsandbox.siteintercept.qualtrics.com/SIE/?Q_ZID=ZN_9BwReAmgWdWatNf")).start();
            } catch(i){
                console.error("Qualtrics intercept loading error: ", i);
            }
        })();
//ADA focus changes code test
const iframe = document.querySelector('.QSIWebResponsiveDialog-Layout1-SI_8Jna9K5PTcSmf3w_embedded-target-container > iframe')

const originalStates = new Map();

const applyRestrictions = () => {
  const elementsToHide = Array.from(document.querySelectorAll('body *'))
    .filter(element => element !== iframe && !iframe.contains(element));

  elementsToHide.forEach(element => {
    originalStates.set(element, {
      ariaHidden: element.getAttribute('aria-hidden'),
      tabindex: element.getAttribute('tabindex')
    });
    element.setAttribute('aria-hidden', 'true');
    element.setAttribute('tabindex', '-1');
  });
  window.__originalAccessibilityStates = originalStates;
};

const removeRestrictions = () => {
  const storedStates = window.__originalAccessibilityStates;
  if (storedStates) {
    storedStates.forEach((state, element) => {
      if (state.ariaHidden === null) {
        element.removeAttribute('aria-hidden');
      } else {
        element.setAttribute('aria-hidden', state.ariaHidden);
      }

      if (state.tabindex === null) {
        element.removeAttribute('tabindex');
      } else {
        element.setAttribute('tabindex', state.tabindex);
      }
    });
    delete window.__originalAccessibilityStates; // Clean up the stored states
  }
};

const observer = new MutationObserver((mutationsList, observer) => {
  for (const mutation of mutationsList) {
    // Check for style changes on the iframe to detect visibility
    if (mutation.target === iframe && mutation.type === 'attributes' && mutation.attributeName === 'style') {
      const display = window.getComputedStyle(iframe).display;
      const visibility = window.getComputedStyle(iframe).visibility;

      if (display !== 'none' && visibility !== 'hidden') {
        // Iframe is now visible, apply restrictions
        applyRestrictions();
      } else {
        // Iframe is hidden, remove restrictions (if they were applied)
        // This handles cases where the iframe might be hidden without being removed
        removeRestrictions();
      }
    }

    // Check for removal of the iframe from its parent to detect closure
    if (mutation.type === 'childList') {
      mutation.removedNodes.forEach(removedNode => {
        if (removedNode === iframe) {
          // The iframe was removed, execute cleanup
          removeRestrictions();
          observer.disconnect(); // Stop observing once the iframe is removed
        }
      });
    }
  }
});

// Start observing the iframe's style attribute and its parent's child list
if (iframe.parentElement) {
  observer.observe(iframe, { attributes: true, attributeFilter: ['style'] });
  observer.observe(iframe.parentElement, { childList: true });
}


// Initial check in case the iframe is already visible on load
const initialDisplay = window.getComputedStyle(iframe).display;
const initialVisibility = window.getComputedStyle(iframe).visibility;
if (initialDisplay !== 'none' && initialVisibility !== 'hidden') {
  applyRestrictions();
}


const data = {
  message: "MutationObserver attached to iframe and its parent to handle visibility and removal."
};

    </script>
    <div id='ZN_9BwReAmgWdWatNf'><!--DO NOT REMOVE-CONTENTS PLACED HERE--></div>
</body>

</html>
